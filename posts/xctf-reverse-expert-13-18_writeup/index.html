<!DOCTYPE html>
<html lang="en"><head>
    <title>OPdbg</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://OolongCode.github.io/favicon.ico">
    <link rel="canonical" href="https://OolongCode.github.io">
    
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://OolongCode.github.io">OPdbg</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/about/">
                                    
                                    <span>About</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/posts">
                                    
                                    <span>All posts</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/tags">
                                    
                                    <span>Tags</span>
                                </a>
                            </li>
                        
                    
                        
                            <li>
                                <a href="/link">
                                    
                                    <span>Link</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>XCTF REVERSE Expert [13~18]_Writeup - Fri, Jan 28, 2022</h1>
    </div>
    <p class="lead"></p>
    <h1 id="xctf-reverse-高手区-13-18-writeup">XCTF-REVERSE-高手区-[13-18] writeup</h1>
<p>继续玩一玩逆向的题目，感觉还是蛮有意思的。</p>
<h2 id="0x0-srm-50">0x0 srm-50</h2>
<p>使用DIE进行探测：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103093725322.png" alt="image-20211103093725322"></p>
<p>32位PE程序，无壳。可以尝试运行一下：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103093811981.png" alt="image-20211103093811981"></p>
<p>应该是一个邮箱破解的程序，终于有点稍微有意思的题目了</p>
<p>首先进行静态分析看代码：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103094139950.png" alt="image-20211103094139950"></p>
<p>根据WIN32的编程基础，关键函数应该是在<code>DialogFunc</code>中，登录的细节应该是在<code>DialogFunc</code>中。</p>
<p>跟进<code>DialogFunc</code>函数，来寻找更多的细节</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">INT_PTR <span style="color:#66d9ef">__stdcall</span> <span style="color:#a6e22e">DialogFunc</span>(HWND hDlg, UINT a2, WPARAM a3, LPARAM a4)
{
  HMODULE v5; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  HICON v6; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  HMODULE v7; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  HWND v8; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  HCURSOR v9; <span style="color:#75715e">// [esp-4h] [ebp-34Ch]
</span><span style="color:#75715e"></span>  CHAR String[<span style="color:#ae81ff">256</span>]; <span style="color:#75715e">// [esp+8h] [ebp-340h] BYREF
</span><span style="color:#75715e"></span>  CHAR v11[<span style="color:#ae81ff">256</span>]; <span style="color:#75715e">// [esp+108h] [ebp-240h] BYREF
</span><span style="color:#75715e"></span>  CHAR Text[<span style="color:#ae81ff">256</span>]; <span style="color:#75715e">// [esp+208h] [ebp-140h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> Source[<span style="color:#ae81ff">60</span>]; <span style="color:#75715e">// [esp+308h] [ebp-40h] BYREF
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">if</span> ( a2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">16</span> )
  {
    EndDialog(hDlg, <span style="color:#ae81ff">0</span>);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
  }
  <span style="color:#66d9ef">if</span> ( a2 <span style="color:#f92672">==</span> <span style="color:#ae81ff">272</span> )
  {
    v5 <span style="color:#f92672">=</span> GetModuleHandleW(<span style="color:#ae81ff">0</span>);
    v6 <span style="color:#f92672">=</span> LoadIconW(v5, (LPCWSTR)<span style="color:#ae81ff">0x67</span>);
    SetClassLongA(hDlg, <span style="color:#f92672">-</span><span style="color:#ae81ff">14</span>, (LONG)v6);
    v7 <span style="color:#f92672">=</span> GetModuleHandleW(<span style="color:#ae81ff">0</span>);
    v9 <span style="color:#f92672">=</span> LoadCursorW(v7, (LPCWSTR)<span style="color:#ae81ff">0x66</span>);
    v8 <span style="color:#f92672">=</span> GetDlgItem(hDlg, <span style="color:#ae81ff">1</span>);
    SetClassLongA(v8, <span style="color:#f92672">-</span><span style="color:#ae81ff">12</span>, (LONG)v9);
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
  }
  <span style="color:#66d9ef">if</span> ( a2 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">273</span> <span style="color:#f92672">||</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)a3 <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
  memset(String, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int16</span>)a3 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">sizeof</span>(String));
  memset(v11, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(v11));
  memset(Text, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(Text));
  GetDlgItemTextA(hDlg, <span style="color:#ae81ff">1001</span>, String, <span style="color:#ae81ff">256</span>);
  GetDlgItemTextA(hDlg, <span style="color:#ae81ff">1002</span>, v11, <span style="color:#ae81ff">256</span>);
  <span style="color:#66d9ef">if</span> ( strstr(String, <span style="color:#e6db74">&#34;@&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> strstr(String, <span style="color:#e6db74">&#34;.&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> strstr(String, <span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;&amp;</span> strstr(String, <span style="color:#e6db74">&#34;@&#34;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">46</span> )
  {
    strcpy(<span style="color:#f92672">&amp;</span>Source[<span style="color:#ae81ff">36</span>], <span style="color:#e6db74">&#34;Registration failure.&#34;</span>);
    strcpy(Source, <span style="color:#e6db74">&#34;Registration Success!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Your flag is:&#34;</span>);
    <span style="color:#66d9ef">if</span> ( strlen(v11) <span style="color:#f92672">==</span> <span style="color:#ae81ff">16</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">67</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">88</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">90</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">65</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">57</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">13</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">98</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">55</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">109</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">71</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">113</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">57</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">52</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">103</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">99</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">56</span> )
    {
      strcpy_s(Text, <span style="color:#ae81ff">0x100u</span>, Source);
      strcat_s(Text, <span style="color:#ae81ff">0x100u</span>, v11);
    }
    <span style="color:#66d9ef">else</span>
    {
      strcpy_s(Text, <span style="color:#ae81ff">0x100u</span>, <span style="color:#f92672">&amp;</span>Source[<span style="color:#ae81ff">36</span>]);
    }
  }
  <span style="color:#66d9ef">else</span>
  {
    strcpy_s(Text, <span style="color:#ae81ff">0x100u</span>, <span style="color:#e6db74">&#34;Your E-mail address in not valid.&#34;</span>);
  }
  MessageBoxA(hDlg, Text, <span style="color:#e6db74">&#34;Registeration&#34;</span>, <span style="color:#ae81ff">0x40u</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>flag直接展示的非常清晰了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">if</span> ( strstr(String, <span style="color:#e6db74">&#34;@&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> strstr(String, <span style="color:#e6db74">&#34;.&#34;</span>) <span style="color:#f92672">&amp;&amp;</span> strstr(String, <span style="color:#e6db74">&#34;.&#34;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;&amp;</span> strstr(String, <span style="color:#e6db74">&#34;@&#34;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">!=</span> <span style="color:#ae81ff">46</span> )
  {
    strcpy(<span style="color:#f92672">&amp;</span>Source[<span style="color:#ae81ff">36</span>], <span style="color:#e6db74">&#34;Registration failure.&#34;</span>);
    strcpy(Source, <span style="color:#e6db74">&#34;Registration Success!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Your flag is:&#34;</span>);
    <span style="color:#66d9ef">if</span> ( strlen(v11) <span style="color:#f92672">==</span> <span style="color:#ae81ff">16</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">67</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">15</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">88</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">90</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">65</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">57</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">13</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">98</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">100</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">55</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">109</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">11</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">71</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">5</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">113</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">10</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">57</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">52</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">103</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">7</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">99</span>
      <span style="color:#f92672">&amp;&amp;</span> v11[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">56</span> )
    {
      strcpy_s(Text, <span style="color:#ae81ff">0x100u</span>, Source);
      strcat_s(Text, <span style="color:#ae81ff">0x100u</span>, v11);
    }
    <span style="color:#66d9ef">else</span>
    {
      strcpy_s(Text, <span style="color:#ae81ff">0x100u</span>, <span style="color:#f92672">&amp;</span>Source[<span style="color:#ae81ff">36</span>]);
    }
  }
</code></pre></div><p>对<code>v11</code>数组进行运算就可以得到，非常简单，可以非常容易地得到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">CZ9dmq4c8g9G7bAX
</code></pre></div><p>故本题的flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">CZ9dmq4c8g9G7bAX
</code></pre></div><h2 id="0x1-simple-check-100">0x1 simple-check-100</h2>
<p>先使用DIE姐姐进行探测一下，呐呐~</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103095757150.png" alt="image-20211103095757150"></p>
<p>PE32程序，没有加壳。直接静态分析看一波：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v3; <span style="color:#75715e">// esp
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>v4; <span style="color:#75715e">// esp
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v6; <span style="color:#75715e">// [esp+8h] [ebp-40h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v7; <span style="color:#75715e">// [esp+1Bh] [ebp-2Dh] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>v8; <span style="color:#75715e">// [esp+1Ch] [ebp-2Ch]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v9; <span style="color:#75715e">// [esp+20h] [ebp-28h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v10; <span style="color:#75715e">// [esp+25h] [ebp-23h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v11; <span style="color:#75715e">// [esp+26h] [ebp-22h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v12; <span style="color:#75715e">// [esp+27h] [ebp-21h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v13; <span style="color:#75715e">// [esp+28h] [ebp-20h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v14; <span style="color:#75715e">// [esp+29h] [ebp-1Fh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v15; <span style="color:#75715e">// [esp+2Ah] [ebp-1Eh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v16; <span style="color:#75715e">// [esp+2Bh] [ebp-1Dh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v17; <span style="color:#75715e">// [esp+2Ch] [ebp-1Ch]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v18; <span style="color:#75715e">// [esp+2Dh] [ebp-1Bh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v19; <span style="color:#75715e">// [esp+2Eh] [ebp-1Ah]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v20; <span style="color:#75715e">// [esp+2Fh] [ebp-19h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v21; <span style="color:#75715e">// [esp+30h] [ebp-18h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v22; <span style="color:#75715e">// [esp+31h] [ebp-17h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v23; <span style="color:#75715e">// [esp+32h] [ebp-16h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v24; <span style="color:#75715e">// [esp+33h] [ebp-15h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v25; <span style="color:#75715e">// [esp+34h] [ebp-14h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v26; <span style="color:#75715e">// [esp+35h] [ebp-13h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v27; <span style="color:#75715e">// [esp+36h] [ebp-12h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v28; <span style="color:#75715e">// [esp+37h] [ebp-11h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v29; <span style="color:#75715e">// [esp+38h] [ebp-10h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v30; <span style="color:#75715e">// [esp+39h] [ebp-Fh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v31; <span style="color:#75715e">// [esp+3Ah] [ebp-Eh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v32; <span style="color:#75715e">// [esp+3Bh] [ebp-Dh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v33; <span style="color:#75715e">// [esp+3Ch] [ebp-Ch]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v34; <span style="color:#75715e">// [esp+3Dh] [ebp-Bh]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v35; <span style="color:#75715e">// [esp+3Eh] [ebp-Ah]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v36; <span style="color:#75715e">// [esp+3Fh] [ebp-9h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>v37; <span style="color:#75715e">// [esp+40h] [ebp-8h]
</span><span style="color:#75715e"></span>
  v37 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>argc;
  __main();
  v7 <span style="color:#f92672">=</span> <span style="color:#ae81ff">84</span>;
  v36 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">56</span>;
  v35 <span style="color:#f92672">=</span> <span style="color:#ae81ff">126</span>;
  v34 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">29</span>;
  v33 <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
  v32 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">57</span>;
  v31 <span style="color:#f92672">=</span> <span style="color:#ae81ff">22</span>;
  v30 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">102</span>;
  v29 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">51</span>;
  v28 <span style="color:#f92672">=</span> <span style="color:#ae81ff">17</span>;
  v27 <span style="color:#f92672">=</span> <span style="color:#ae81ff">101</span>;
  v26 <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>;
  v25 <span style="color:#f92672">=</span> <span style="color:#ae81ff">45</span>;
  v24 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">29</span>;
  v23 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">45</span>;
  v22 <span style="color:#f92672">=</span> <span style="color:#ae81ff">67</span>;
  v21 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">110</span>;
  v20 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">87</span>;
  v19 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">99</span>;
  v18 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">46</span>;
  v17 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">26</span>;
  v16 <span style="color:#f92672">=</span> <span style="color:#ae81ff">109</span>;
  v15 <span style="color:#f92672">=</span> <span style="color:#ae81ff">44</span>;
  v14 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">45</span>;
  v13 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">74</span>;
  v12 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">67</span>;
  v11 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>;
  v10 <span style="color:#f92672">=</span> <span style="color:#ae81ff">106</span>;
  v9 <span style="color:#f92672">=</span> <span style="color:#ae81ff">19</span>;
  v3 <span style="color:#f92672">=</span> alloca(<span style="color:#ae81ff">32</span>);
  v4 <span style="color:#f92672">=</span> alloca(<span style="color:#ae81ff">32</span>);
  v8 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>v6;
  printf(<span style="color:#e6db74">&#34;Key: &#34;</span>);
  scanf(<span style="color:#e6db74">&#34;%s&#34;</span>, v8);
  <span style="color:#66d9ef">if</span> ( check_key((<span style="color:#66d9ef">int</span>)v8) )
    interesting_function((<span style="color:#66d9ef">int</span>)<span style="color:#f92672">&amp;</span>v7);
  <span style="color:#66d9ef">else</span>
    puts(<span style="color:#e6db74">&#34;Wrong&#34;</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>关键函数是<code>check_key</code>函数，只要对<code>check_key</code>函数进行绕过应该就可以拿到flag</p>
<p>使用Ollydbg进行动态调试：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103155250920.png" alt="image-20211103155250920"></p>
<p>发现Ollydbg总是会输出乱码。不能够正确地将flag输出出来，可能是由于WINDOW编码的问题，也可能是由于题目的WINDOWS程序没有写好。需要再进行对Linux程序进行分析，但是考虑到Linux程序的代码应该是和Windows的代码结构大致一致</p>
<p>把程序拖到Kali Linux中，使用GDB进行调试：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103160210709.png" alt="image-20211103160210709"></p>
<p>成功调试出了flag：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag_is_you_know_cracking!!!
</code></pre></div><h2 id="0x2-mysterious">0x2 Mysterious</h2>
<p>先使用DIE探测一下：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103163229333.png" alt="image-20211103163229333"></p>
<p>32位PE程序，无壳</p>
<p>尝试运行一下这个程序：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103163501910.png" alt="image-20211103163501910"></p>
<p>密码破解的程序，先进行静态分析确定位置：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103163903336.png" alt="image-20211103163903336"></p>
<p>经典的WIN32程序，继续跟进</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103164106092.png" alt="image-20211103164106092"></p>
<p>跟进<code>DialogFunc</code>函数，这个函数主要就是WIN32的窗口创建函数，代码逻辑应该就在WIN32中。</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103164207779.png" alt="image-20211103164207779"></p>
<p>继续跟进，胜利就在前方！</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103164237890.png" alt="image-20211103164237890"></p>
<p>找到主要的逻辑函数，在下面寻找逻辑判断语句</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103164423968.png" alt="image-20211103164423968"></p>
<p>这个<code>loc_401183</code>应该是关键函数，这个函数的地址是<code>0x401183</code>，使用Ollydbg进行同时调试来绕过这个判断条件直接出flag</p>
<p>使用Ollydbg，使用快捷键<code>CTRL+G</code>快速跳转到<code>0x401183</code>的地址，同时也要根据代码静态分析的逻辑来进行判断，发现需要进行输入的代码段是122，这个可以作为Key进行输入：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103165814525.png" alt="image-20211103165814525"></p>
<p>在Ollydbg中修改汇编，修改跳转条件，然后输入122</p>
<p>就可以拿到flag了</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103171857297.png" alt="image-20211103171857297"></p>
<p>flag为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag{123_Buff3r_0v3rf|0w}
</code></pre></div><hr>
<p>本题还有一种更简单的解法，就是直接静态分析来读取密码直接输入来拿到flag</p>
<p>本菜鸡只是希望可以学习到更多的技能点，于是使用另一种思路进行求解。</p>
<h2 id="0x3-re1-100">0x3 re1-100</h2>
<p>先进行一下探测：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103172548605.png" alt="image-20211103172548605"></p>
<p>64位的ELF文件，直接静态分析：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103172742437.png" alt="image-20211103172742437"></p>
<p>代码中有反调试函数，这道题目使用动态调试会有些麻烦，应该是使用静态调试进行求解</p>
<p>查看静态调试代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> __noreturn <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  __pid_t v3; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  size_t v4; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  ssize_t v5; <span style="color:#75715e">// rbx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> v6; <span style="color:#75715e">// al
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> bCheckPtrace; <span style="color:#75715e">// [rsp+13h] [rbp-1BDh]
</span><span style="color:#75715e"></span>  ssize_t numRead; <span style="color:#75715e">// [rsp+18h] [rbp-1B8h]
</span><span style="color:#75715e"></span>  ssize_t numReada; <span style="color:#75715e">// [rsp+18h] [rbp-1B8h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> bufWrite[<span style="color:#ae81ff">200</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-1B0h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> bufParentRead[<span style="color:#ae81ff">200</span>]; <span style="color:#75715e">// [rsp+F0h] [rbp-E0h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v12; <span style="color:#75715e">// [rsp+1B8h] [rbp-18h]
</span><span style="color:#75715e"></span>
  v12 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  bCheckPtrace <span style="color:#f92672">=</span> detectDebugging();
  <span style="color:#66d9ef">if</span> ( pipe(pParentWrite) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
    exit(<span style="color:#ae81ff">1</span>);
  <span style="color:#66d9ef">if</span> ( pipe(pParentRead) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
    exit(<span style="color:#ae81ff">1</span>);
  v3 <span style="color:#f92672">=</span> fork();
  <span style="color:#66d9ef">if</span> ( v3 <span style="color:#f92672">!=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
  {
    <span style="color:#66d9ef">if</span> ( v3 )
    {
      close(pParentWrite[<span style="color:#ae81ff">0</span>]);
      close(pParentRead[<span style="color:#ae81ff">1</span>]);
      <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
      {
        printf(<span style="color:#e6db74">&#34;Input key : &#34;</span>);
        memset(bufWrite, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(bufWrite));
        gets(bufWrite);
        v4 <span style="color:#f92672">=</span> strlen(bufWrite);
        v5 <span style="color:#f92672">=</span> write(pParentWrite[<span style="color:#ae81ff">1</span>], bufWrite, v4);
        <span style="color:#66d9ef">if</span> ( v5 <span style="color:#f92672">!=</span> strlen(bufWrite) )
          printf(<span style="color:#e6db74">&#34;parent - partial/failed write&#34;</span>);
        <span style="color:#66d9ef">do</span>
        {
          memset(bufParentRead, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(bufParentRead));
          numReada <span style="color:#f92672">=</span> read(pParentRead[<span style="color:#ae81ff">0</span>], bufParentRead, <span style="color:#ae81ff">0xC8uLL</span>);
          v6 <span style="color:#f92672">=</span> bCheckPtrace <span style="color:#f92672">||</span> checkDebuggerProcessRunning();
          <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v6 <span style="color:#f92672">&amp;&amp;</span> checkStringIsNumber(bufParentRead) <span style="color:#f92672">&amp;&amp;</span> atoi(bufParentRead) )
          {
            puts(<span style="color:#e6db74">&#34;True&#34;</span>);
            <span style="color:#66d9ef">if</span> ( close(pParentWrite[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
              exit(<span style="color:#ae81ff">1</span>);
            exit(<span style="color:#ae81ff">0</span>);
          }
          puts(<span style="color:#e6db74">&#34;Wrong !!!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        }
        <span style="color:#66d9ef">while</span> ( numReada <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> );
      }
    }
    close(pParentWrite[<span style="color:#ae81ff">1</span>]);
    close(pParentRead[<span style="color:#ae81ff">0</span>]);
    <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
    {
      memset(bufParentRead, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(bufParentRead));
      numRead <span style="color:#f92672">=</span> read(pParentWrite[<span style="color:#ae81ff">0</span>], bufParentRead, <span style="color:#ae81ff">0xC8uLL</span>);
      <span style="color:#66d9ef">if</span> ( numRead <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> )
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">if</span> ( numRead )
      {
        <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>childCheckDebugResult()
          <span style="color:#f92672">&amp;&amp;</span> bufParentRead[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">123</span>
          <span style="color:#f92672">&amp;&amp;</span> strlen(bufParentRead) <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;*&#39;</span>
          <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>strncmp(<span style="color:#f92672">&amp;</span>bufParentRead[<span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;53fc275d81&#34;</span>, <span style="color:#ae81ff">0xAuLL</span>)
          <span style="color:#f92672">&amp;&amp;</span> bufParentRead[strlen(bufParentRead) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">125</span>
          <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>strncmp(<span style="color:#f92672">&amp;</span>bufParentRead[<span style="color:#ae81ff">31</span>], <span style="color:#e6db74">&#34;4938ae4efd&#34;</span>, <span style="color:#ae81ff">0xAuLL</span>)
          <span style="color:#f92672">&amp;&amp;</span> confuseKey(bufParentRead, <span style="color:#ae81ff">42</span>)
          <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>strncmp(bufParentRead, <span style="color:#e6db74">&#34;{daf29f59034938ae4efd53fc275d81053ed5be8c}&#34;</span>, <span style="color:#ae81ff">0x2AuLL</span>) )
        {
          responseTrue();
        }
        <span style="color:#66d9ef">else</span>
        {
          responseFalse();
        }
      }
    }
    exit(<span style="color:#ae81ff">1</span>);
  }
  exit(<span style="color:#ae81ff">1</span>);
}
</code></pre></div><p>发现存在有一个可疑的字符串：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">{daf29f59034938ae4efd53fc275d81053ed5be8c}
</code></pre></div><p>这个字符串可能是flag，但是感觉似乎有些不太对劲</p>
<p>往上观察，发现存在有一个进行变换的函数<code>confusekey</code></p>
<p>进入这个函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">bool</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">confuseKey</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>szKey, <span style="color:#66d9ef">int</span> iKeyLength)
{
  <span style="color:#66d9ef">char</span> szPart1[<span style="color:#ae81ff">15</span>]; <span style="color:#75715e">// [rsp+10h] [rbp-50h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> szPart2[<span style="color:#ae81ff">15</span>]; <span style="color:#75715e">// [rsp+20h] [rbp-40h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> szPart3[<span style="color:#ae81ff">15</span>]; <span style="color:#75715e">// [rsp+30h] [rbp-30h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> szPart4[<span style="color:#ae81ff">15</span>]; <span style="color:#75715e">// [rsp+40h] [rbp-20h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v7; <span style="color:#75715e">// [rsp+58h] [rbp-8h]
</span><span style="color:#75715e"></span>
  v7 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)szPart1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart1[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart1[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  szPart1[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)szPart2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart2[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart2[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  szPart2[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)szPart3 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart3[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart3[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  szPart3[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_QWORD <span style="color:#f92672">*</span>)szPart4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0LL</span>;
  <span style="color:#f92672">*</span>(_DWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart4[<span style="color:#ae81ff">8</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#f92672">*</span>(_WORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>szPart4[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  szPart4[<span style="color:#ae81ff">14</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> ( iKeyLength <span style="color:#f92672">!=</span> <span style="color:#ae81ff">42</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>szKey )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> ( strlen(szKey) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">42</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">*</span>szKey <span style="color:#f92672">!=</span> <span style="color:#ae81ff">123</span> )
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
  strncpy(szPart1, szKey <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0xAuLL</span>);
  strncpy(szPart2, szKey <span style="color:#f92672">+</span> <span style="color:#ae81ff">11</span>, <span style="color:#ae81ff">0xAuLL</span>);
  strncpy(szPart3, szKey <span style="color:#f92672">+</span> <span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">0xAuLL</span>);
  strncpy(szPart4, szKey <span style="color:#f92672">+</span> <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">0xAuLL</span>);
  memset(szKey, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0x2AuLL</span>);
  <span style="color:#f92672">*</span>szKey <span style="color:#f92672">=</span> <span style="color:#ae81ff">123</span>;
  strcat(szKey, szPart3);
  strcat(szKey, szPart4);
  strcat(szKey, szPart1);
  strcat(szKey, szPart2);
  szKey[<span style="color:#ae81ff">41</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">125</span>;
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>发现字符串发生了位置的变化，将位置变化还原应该就是flag</p>
<p>看代码可以直接对字符进行变换处理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">53fc275d81053ed5be8cdaf29f59034938ae4efd
</code></pre></div><p>本题的flag为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">53fc275d81053ed5be8cdaf29f59034938ae4efd
</code></pre></div><h2 id="0x4-crazy">0x4 crazy</h2>
<p>探测探测，看看是什么样的程序：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103185717266.png" alt="image-20211103185717266"></p>
<p>64位的ELF程序，无壳。直接上静态分析看一看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v5; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v6; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v7; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v8; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v9; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v10; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v11; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v12; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v13; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v14; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v15; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v16; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v18[<span style="color:#ae81ff">32</span>]; <span style="color:#75715e">// [rsp+10h] [rbp-130h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v19[<span style="color:#ae81ff">32</span>]; <span style="color:#75715e">// [rsp+30h] [rbp-110h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v20[<span style="color:#ae81ff">32</span>]; <span style="color:#75715e">// [rsp+50h] [rbp-F0h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v21[<span style="color:#ae81ff">32</span>]; <span style="color:#75715e">// [rsp+70h] [rbp-D0h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v22[<span style="color:#ae81ff">32</span>]; <span style="color:#75715e">// [rsp+90h] [rbp-B0h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v23[<span style="color:#ae81ff">120</span>]; <span style="color:#75715e">// [rsp+B0h] [rbp-90h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v24; <span style="color:#75715e">// [rsp+128h] [rbp-18h]
</span><span style="color:#75715e"></span>
  v24 <span style="color:#f92672">=</span> __readfsqword(<span style="color:#ae81ff">0x28u</span>);
  std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span>basic_string(v18, argv, envp);
  std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&gt;&gt;&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cin, v18);
  v3 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;-------------------------------------------&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v3, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  v4 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;Quote from people&#39;s champ&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v4, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  v5 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;-------------------------------------------&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v5, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  v6 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(
         <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout,
         <span style="color:#e6db74">&#34;*My goal was never to be the loudest or the craziest. It was to be the most entertaining.&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v6, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  v7 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;*Wrestling was like stand-up comedy for me.&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v7, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  v8 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(
         <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout,
         <span style="color:#e6db74">&#34;*I like to use the hard times in the past to motivate me today.&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v8, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  v9 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;-------------------------------------------&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v9, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  HighTemplar<span style="color:#f92672">::</span>HighTemplar((DarkTemplar <span style="color:#f92672">*</span>)v23, (<span style="color:#66d9ef">__int64</span>)v18);
  v10 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;Checking....&#34;</span>);
  std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v10, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span>basic_string(v19, v18);
  func1(v20, v19);
  func2(v21, v20);
  func3(v21, <span style="color:#ae81ff">0LL</span>);
  std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::~</span>basic_string(v21);
  std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::~</span>basic_string(v20);
  std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::~</span>basic_string(v19);
  HighTemplar<span style="color:#f92672">::</span>calculate((HighTemplar <span style="color:#f92672">*</span>)v23);
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)HighTemplar<span style="color:#f92672">::</span>getSerial((HighTemplar <span style="color:#f92672">*</span>)v23) )
  {
    v11 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;/////////////////////////////////&#34;</span>);
    std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v11, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
    v12 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;Do not be angry. Happy Hacking :)&#34;</span>);
    std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v12, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
    v13 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;/////////////////////////////////&#34;</span>);
    std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v13, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
    HighTemplar<span style="color:#f92672">::</span>getFlag[abi:cxx11](v22, v23);
    v14 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;flag{&#34;</span>);
    v15 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>(v14, v22);
    v16 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(v15, <span style="color:#e6db74">&#34;}&#34;</span>);
    std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v16, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
    std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::~</span>basic_string(v22);
  }
  HighTemplar<span style="color:#f92672">::~</span>HighTemplar((HighTemplar <span style="color:#f92672">*</span>)v23);
  std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::~</span>basic_string(v18);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>这道题目的难点应该是C++反汇编反编译代码的阅读，需要寻找关键函数：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">HighTemplar<span style="color:#f92672">::</span>HighTemplar((DarkTemplar <span style="color:#f92672">*</span>)v23, (<span style="color:#66d9ef">__int64</span>)v18); <span style="color:#75715e">// 数据：&#34;327a6c4304ad5938eaf0efb6cc3e53dc&#34;
</span><span style="color:#75715e"></span>HighTemplar<span style="color:#f92672">::</span>calculate((HighTemplar <span style="color:#f92672">*</span>)v23); <span style="color:#75715e">// 加密
</span><span style="color:#75715e"></span>HighTemplar<span style="color:#f92672">::</span>getSerial((HighTemplar <span style="color:#f92672">*</span>)v23); <span style="color:#75715e">// 验证
</span></code></pre></div><p>现在通过审计获得了三个关键函数，现在就可以逐一分析了</p>
<p>先看看加密：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">bool</span> <span style="color:#66d9ef">__fastcall</span> HighTemplar<span style="color:#f92672">::</span>calculate(HighTemplar <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>)
{
  <span style="color:#66d9ef">__int64</span> v1; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  _BYTE <span style="color:#f92672">*</span>v2; <span style="color:#75715e">// rbx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">bool</span> result; <span style="color:#75715e">// al
</span><span style="color:#75715e"></span>  _BYTE <span style="color:#f92672">*</span>v4; <span style="color:#75715e">// rbx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+18h] [rbp-18h]
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> j; <span style="color:#75715e">// [rsp+1Ch] [rbp-14h]
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">if</span> ( std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span>length((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">32</span> )
  {
    v1 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;Too short or too long&#34;</span>);
    std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v1, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
    exit(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
  }
  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        i <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span>length((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>);
        <span style="color:#f92672">++</span>i )
  {
    v2 <span style="color:#f92672">=</span> (_BYTE <span style="color:#f92672">*</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span><span style="color:#66d9ef">operator</span>[](
                    (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>,
                    i);
    <span style="color:#f92672">*</span>v2 <span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>(_BYTE <span style="color:#f92672">*</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span><span style="color:#66d9ef">operator</span>[](
                       (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>,
                       i) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x50</span>)
        <span style="color:#f92672">+</span> <span style="color:#ae81ff">23</span>;
  }
  <span style="color:#66d9ef">for</span> ( j <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; ; <span style="color:#f92672">++</span>j )
  {
    result <span style="color:#f92672">=</span> j <span style="color:#f92672">&lt;=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span>length((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>);
    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>result )
      <span style="color:#66d9ef">break</span>;
    v4 <span style="color:#f92672">=</span> (_BYTE <span style="color:#f92672">*</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span><span style="color:#66d9ef">operator</span>[](
                    (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>,
                    j);
    <span style="color:#f92672">*</span>v4 <span style="color:#f92672">=</span> (<span style="color:#f92672">*</span>(_BYTE <span style="color:#f92672">*</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span><span style="color:#66d9ef">operator</span>[](
                       (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>,
                       j) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x13</span>)
        <span style="color:#f92672">+</span> <span style="color:#ae81ff">11</span>;
  }
  <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><p>对加密代码简要分析就是：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">c <span style="color:#f92672">=</span> (((m <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x50</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">23</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x13</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">11</span>
</code></pre></div><p>然后查看一下验证函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> HighTemplar<span style="color:#f92672">::</span>getSerial(HighTemplar <span style="color:#f92672">*</span><span style="color:#66d9ef">this</span>)
{
  <span style="color:#66d9ef">char</span> v1; <span style="color:#75715e">// bl
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v5; <span style="color:#75715e">// rax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+1Ch] [rbp-14h]
</span><span style="color:#75715e"></span>
  <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
        (<span style="color:#66d9ef">int</span>)i <span style="color:#f92672">&lt;</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span>length((<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>);
        <span style="color:#f92672">++</span>i )
  {
    v1 <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(_BYTE <span style="color:#f92672">*</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span><span style="color:#66d9ef">operator</span>[](
                     (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">80</span>,
                     (<span style="color:#66d9ef">int</span>)i);
    <span style="color:#66d9ef">if</span> ( v1 <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>(_BYTE <span style="color:#f92672">*</span>)std<span style="color:#f92672">::</span>__cxx11<span style="color:#f92672">::</span>basic_string<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;</span>,std<span style="color:#f92672">::</span>allocator<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;::</span><span style="color:#66d9ef">operator</span>[](
                           (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>,
                           (<span style="color:#66d9ef">int</span>)i) )
    {
      v4 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;You did not pass &#34;</span>);
      v5 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v4, i);
      std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v5, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
      <span style="color:#f92672">*</span>((_DWORD <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>) <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
      <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>);
    }
    v2 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;&lt;</span>std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>(<span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>cout, <span style="color:#e6db74">&#34;Pass &#34;</span>);
    v3 <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v2, i);
    std<span style="color:#f92672">::</span>ostream<span style="color:#f92672">::</span><span style="color:#66d9ef">operator</span><span style="color:#f92672">&lt;&lt;</span>(v3, <span style="color:#f92672">&amp;</span>std<span style="color:#f92672">::</span>endl<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span>,std<span style="color:#f92672">::</span>char_traits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">char</span><span style="color:#f92672">&gt;&gt;</span>);
  }
  <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)<span style="color:#66d9ef">this</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">3</span>);
}
</code></pre></div><p>也是对于字符<code>327a6c4304ad5938eaf0efb6cc3e53dc</code>的验证</p>
<p>于是这道题目就非常简单了，直接对于异或操作进行逆向求解，写个python即可求解：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">data<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;327a6c4304ad5938eaf0efb6cc3e53dc&#39;</span>
flag<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(data)):
    n<span style="color:#f92672">=</span>ord(data[i])
    flag<span style="color:#f92672">+=</span>chr((((n<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>)<span style="color:#f92672">^</span><span style="color:#ae81ff">0x13</span>)<span style="color:#f92672">-</span><span style="color:#ae81ff">23</span>)<span style="color:#f92672">^</span><span style="color:#ae81ff">0x50</span>)
print(<span style="color:#e6db74">&#39;flag{&#39;</span><span style="color:#f92672">+</span>flag<span style="color:#f92672">+</span><span style="color:#e6db74">&#39;}&#39;</span>)
</code></pre></div><p>运行就能得到flag</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag{tMx~qdstOs~crvtwb~aOba}qddtbrtcd}
</code></pre></div><h2 id="0x5-windows-reverse1">0x5 Windows Reverse1</h2>
<p>探测程序：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103200343354.png" alt="image-20211103200343354"></p>
<p>程序是32位PE程序，使用了UPX的压缩壳，需要进行程序脱壳</p>
<p>使用 <code>upx -d</code>命令进行脱壳</p>
<p>脱壳后再次检查：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211103202849197.png" alt="image-20211103202849197"></p>
<p>脱壳之后然后进行静态分析：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>argv, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>envp)
{
  <span style="color:#66d9ef">char</span> v4; <span style="color:#75715e">// [esp+4h] [ebp-804h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v5[<span style="color:#ae81ff">1023</span>]; <span style="color:#75715e">// [esp+5h] [ebp-803h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v6; <span style="color:#75715e">// [esp+404h] [ebp-404h] BYREF
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">char</span> v7[<span style="color:#ae81ff">1023</span>]; <span style="color:#75715e">// [esp+405h] [ebp-403h] BYREF
</span><span style="color:#75715e"></span>
  v6 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  memset(v7, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(v7));
  v4 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  memset(v5, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(v5));
  printf(<span style="color:#e6db74">&#34;please input code:&#34;</span>);
  scanf(<span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#f92672">&amp;</span>v6);
  sub_401000(<span style="color:#f92672">&amp;</span>v6);
  <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>strcmp(<span style="color:#f92672">&amp;</span>v4, <span style="color:#e6db74">&#34;DDCTF{reverseME}&#34;</span>) )
    printf(<span style="color:#e6db74">&#34;You&#39;ve got it!!%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>v4);
  <span style="color:#66d9ef">else</span>
    printf(<span style="color:#e6db74">&#34;Try again later.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>进行静态分析发现，存在一个关键函数在进行处理，即<code>sub_401000</code>函数在进行处理</p>
<p>跟进这个函数</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> <span style="color:#66d9ef">__cdecl</span> <span style="color:#a6e22e">sub_401000</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>a1)
{
  _BYTE <span style="color:#f92672">*</span>v1; <span style="color:#75715e">// ecx
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> v2; <span style="color:#75715e">// edi
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> result; <span style="color:#75715e">// eax
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v4; <span style="color:#75715e">// ebx
</span><span style="color:#75715e"></span>
  v2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  result <span style="color:#f92672">=</span> strlen(a1);
  <span style="color:#66d9ef">if</span> ( result )
  {
    v4 <span style="color:#f92672">=</span> a1 <span style="color:#f92672">-</span> v1;
    <span style="color:#66d9ef">do</span>
    {
      <span style="color:#f92672">*</span>v1 <span style="color:#f92672">=</span> byte_402FF8[(<span style="color:#66d9ef">char</span>)v1[v4]];
      <span style="color:#f92672">++</span>v2;
      <span style="color:#f92672">++</span>v1;
      result <span style="color:#f92672">=</span> strlen(a1);
    }
    <span style="color:#66d9ef">while</span> ( v2 <span style="color:#f92672">&lt;</span> result );
  }
  <span style="color:#66d9ef">return</span> result;
}
</code></pre></div><p>发现这个函数的具体实现算法相对而言是比较难以理解，当然也是本垃圾太菜了，对这个算法的逻辑搞不太清楚。</p>
<p>看看这个代码的汇编语句：</p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211104075853810.png" alt="image-20211104075853810"></p>
<p>对汇编代码的阅读，就可以理解关键语句</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f92672">*</span>v1 <span style="color:#f92672">=</span> byte_402FF8[(<span style="color:#66d9ef">char</span>)v1[v4]];
</code></pre></div><p>这个代码就可以转换为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f92672">*</span>v1 <span style="color:#f92672">=</span> byte_402FF8[(<span style="color:#66d9ef">char</span>)(v1<span style="color:#f92672">+</span>v4)];
</code></pre></div><p>同时，由于：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">v4 <span style="color:#f92672">=</span> a1 <span style="color:#f92672">-</span> v1;
</code></pre></div><p>因此：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#f92672">*</span>v1 <span style="color:#f92672">=</span> byte_402FF8[(<span style="color:#66d9ef">char</span>)a1];
</code></pre></div><p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211104084802229.png" alt="image-20211104084802229"></p>
<p>这样子就很好分析了，就是将<code>a1</code>进行遍历，将数据存储在v1里面。下面就是寻找<code>byte_402FF8</code></p>
<p>由于本题是在进行很多地址的运算，数组也大概率被存储在更高位的地址，依着逻辑去寻找可以找到<code>byte_402FF8</code></p>
<p><img src="/images/XCTF-REVERSE-expert-%5B13-18%5D_writeup/image-20211104085233187.png" alt="image-20211104085233187"></p>
<p>应该就是下面那一坨字符，进行提取就可以了。</p>
<p>现在逻辑已经大致梳理清楚了，可以写个程序进行求解了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;cstring&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
  <span style="color:#66d9ef">char</span> data[]{
    <span style="color:#ae81ff">126</span>, <span style="color:#ae81ff">125</span>, <span style="color:#ae81ff">124</span>, <span style="color:#ae81ff">123</span>, <span style="color:#ae81ff">122</span>, <span style="color:#ae81ff">121</span>, <span style="color:#ae81ff">120</span>, <span style="color:#ae81ff">119</span>, <span style="color:#ae81ff">118</span>, <span style="color:#ae81ff">117</span>, 
    <span style="color:#ae81ff">116</span>, <span style="color:#ae81ff">115</span>, <span style="color:#ae81ff">114</span>, <span style="color:#ae81ff">113</span>, <span style="color:#ae81ff">112</span>, <span style="color:#ae81ff">111</span>, <span style="color:#ae81ff">110</span>, <span style="color:#ae81ff">109</span>, <span style="color:#ae81ff">108</span>, <span style="color:#ae81ff">107</span>, 
    <span style="color:#ae81ff">106</span>, <span style="color:#ae81ff">105</span>, <span style="color:#ae81ff">104</span>, <span style="color:#ae81ff">103</span>, <span style="color:#ae81ff">102</span>, <span style="color:#ae81ff">101</span>, <span style="color:#ae81ff">100</span>,  <span style="color:#ae81ff">99</span>,  <span style="color:#ae81ff">98</span>,  <span style="color:#ae81ff">97</span>, 
     <span style="color:#ae81ff">96</span>,  <span style="color:#ae81ff">95</span>,  <span style="color:#ae81ff">94</span>,  <span style="color:#ae81ff">93</span>,  <span style="color:#ae81ff">92</span>,  <span style="color:#ae81ff">91</span>,  <span style="color:#ae81ff">90</span>,  <span style="color:#ae81ff">89</span>,  <span style="color:#ae81ff">88</span>,  <span style="color:#ae81ff">87</span>, 
     <span style="color:#ae81ff">86</span>,  <span style="color:#ae81ff">85</span>,  <span style="color:#ae81ff">84</span>,  <span style="color:#ae81ff">83</span>,  <span style="color:#ae81ff">82</span>,  <span style="color:#ae81ff">81</span>,  <span style="color:#ae81ff">80</span>,  <span style="color:#ae81ff">79</span>,  <span style="color:#ae81ff">78</span>,  <span style="color:#ae81ff">77</span>, 
     <span style="color:#ae81ff">76</span>,  <span style="color:#ae81ff">75</span>,  <span style="color:#ae81ff">74</span>,  <span style="color:#ae81ff">73</span>,  <span style="color:#ae81ff">72</span>,  <span style="color:#ae81ff">71</span>,  <span style="color:#ae81ff">70</span>,  <span style="color:#ae81ff">69</span>,  <span style="color:#ae81ff">68</span>,  <span style="color:#ae81ff">67</span>, 
     <span style="color:#ae81ff">66</span>,  <span style="color:#ae81ff">65</span>,  <span style="color:#ae81ff">64</span>,  <span style="color:#ae81ff">63</span>,  <span style="color:#ae81ff">62</span>,  <span style="color:#ae81ff">61</span>,  <span style="color:#ae81ff">60</span>,  <span style="color:#ae81ff">59</span>,  <span style="color:#ae81ff">58</span>,  <span style="color:#ae81ff">57</span>, 
     <span style="color:#ae81ff">56</span>,  <span style="color:#ae81ff">55</span>,  <span style="color:#ae81ff">54</span>,  <span style="color:#ae81ff">53</span>,  <span style="color:#ae81ff">52</span>,  <span style="color:#ae81ff">51</span>,  <span style="color:#ae81ff">50</span>,  <span style="color:#ae81ff">49</span>,  <span style="color:#ae81ff">48</span>,  <span style="color:#ae81ff">47</span>, 
     <span style="color:#ae81ff">46</span>,  <span style="color:#ae81ff">45</span>,  <span style="color:#ae81ff">44</span>,  <span style="color:#ae81ff">43</span>,  <span style="color:#ae81ff">42</span>,  <span style="color:#ae81ff">41</span>,  <span style="color:#ae81ff">40</span>,  <span style="color:#ae81ff">39</span>,  <span style="color:#ae81ff">38</span>,  <span style="color:#ae81ff">37</span>, 
     <span style="color:#ae81ff">36</span>,  <span style="color:#ae81ff">35</span>,  <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">33</span>,  <span style="color:#ae81ff">32</span>,   <span style="color:#ae81ff">0</span>
  };
  <span style="color:#66d9ef">char</span> c[]{<span style="color:#e6db74">&#34;DDCTF{reverseME}&#34;</span>};
  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;flag{&#34;</span>;
  <span style="color:#66d9ef">for</span>(size_t i{ <span style="color:#ae81ff">0</span> };i <span style="color:#f92672">&lt;</span> strlen(c);i<span style="color:#f92672">++</span>)
  {
    <span style="color:#66d9ef">for</span>(size_t j{ <span style="color:#ae81ff">0</span> };j <span style="color:#f92672">&lt;</span> strlen(data); j<span style="color:#f92672">++</span>)
    {
      <span style="color:#66d9ef">if</span>(c[i] <span style="color:#f92672">==</span> data[j])
              putchar(<span style="color:#ae81ff">32</span><span style="color:#f92672">+</span>j);
    }
  }
  std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;}&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><p>编译并运行，就能拿到flag啦：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">flag{ZZ[JX#,9(9,+9QY!}
</code></pre></div><p>这道题目坑好多，而且考察的点是相对比较偏的。</p>

    <h4><a href="https://OolongCode.github.io">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>
    <a href="https://gitlab.com/maxlefou/hugo.386">hugo.386 theme by Max le Fou</a> | 

&copy; 
<a href="http://jmf-portfolio.netlify.com" target="_blank">
    JM Fergeau
</a>
<span id="thisyear">2022</span>

    | Example site


</p>
    <p class="text-center">
        
        
        <a href="https://linkedin.com">Linkedin</a> 
        <a href="https://github.com/OolongCode">GitHub</a> 
        <a href="https://gitlab.com">GitLab</a>
    </p>
</footer>

</body><link rel="stylesheet" href="/css/bootstrap.css">
<link rel="stylesheet" href="/css/bootstrap-responsive.css">
<link rel="stylesheet" href="/css/style.css">

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: false ,
        onePass: false , 
        speedFactor: 1 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script></html>
